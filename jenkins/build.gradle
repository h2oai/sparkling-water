apply plugin: 'base'
apply plugin: 'com.bmuschko.docker-remote-api'

import com.bmuschko.gradle.docker.tasks.image.Dockerfile

defaultTasks 'createDockerFile'
description = "Create a Docker file for jenkins tests"

ext {
    outputFile = file("$projectDir//docker/regular-tests/Dockerfile")
    terraformDownloadUrl = "https://releases.hashicorp.com/terraform/${terraformVersion}/terraform_${terraformVersion}_linux_amd64.zip"
}

task createDockerfile(type: Dockerfile) {
    destFile = outputFile
    from 'harbor.h2o.ai/opsh2oai/h2o-3-hadoop-hdp-2.2:73'

    environmentVariable("LANG", "'C.UTF-8'")
    runCommand "locale"
    runCommand "rm -rf /etc/hadoop/conf/yarn-site.xml"
    copyFile("conf/yarn-site.xml", "/etc/hadoop/conf/yarn-site.xml")
    runCommand "rm /etc/startup/70_start_slapd"

    // Install Terraform
    runCommand """\\
                |   curl -s ${terraformDownloadUrl} --output terraform.zip && \\
                |   unzip terraform.zip -d /usr/local/bin/ && \\
                |   rm -f terraform.zip
               """.stripMargin()
    
    runCommand """\\
                R -e 'install.packages("testthat", repos = "http://cran.us.r-project.org")' && \\
                R -e 'install.packages("sparklyr", repos = "http://cran.us.r-project.org")'
                """
    getAllFullSparkVersions().each { version ->
        runCommand """\\
                    cd /home/jenkins && \\
                    wget http://archive.apache.org/dist/spark/spark-${version}/spark-${version}-bin-hadoop2.7.tgz  && \\
                    mkdir -p spark-${version}-bin-hadoop2.7 &&  \\
                    tar zxvf spark-${version}-bin-hadoop2.7.tgz -C spark-${version}-bin-hadoop2.7 --strip-components 1 && \\
                    rm -rf spark-${version}-bin-hadoop2.7.tgz
                    """

        def first = version.split("\\.")[0]
        def second = version.split("\\.")[1]
        environmentVariable("SPARK_HOME_${first}_${second}", "/home/jenkins/spark-${version}-bin-hadoop2.7")
    }

}

def getAllFullSparkVersions() {
    return supportedSparkVersions.split(" ").collect { majorVersion ->
        def props = new Properties()
        file("$rootDir/gradle-spark${majorVersion}.properties").withInputStream { props.load(it) }
        props.get("sparkVersion").toString()
    }
}

task cleanDockerfile(type: Delete) {
    delete outputFile
}

clean.dependsOn cleanDockerfile
