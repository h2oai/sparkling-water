pipeline {
    agent {label 'master'}

    environment {
        SPARK_VERSION="2.1.2"
        BRANCH_DIR="/builds2/sparkling-water/${BRANCH_NAME}"
        BUILD_NUMBER_DIR="${BRANCH_DIR}/${BUILD_NUMBER}"
        SPARK_HOME="${env.WORKSPACE}/spark"
    }

    stages {
        stage('Download Spark') {
            steps {
                sh  """
                        wget -q "http://d3kbcqa49mib13.cloudfront.net/spark-${env.SPARK_VERSION}-bin-hadoop2.7.tgz"
                        mkdir -p "${env.SPARK_HOME}"
                        tar zxvf spark-${env.SPARK_VERSION}-bin-hadoop2.7.tgz -C "${env.SPARK_HOME}" --strip-components 1
                        rm -rf spark-${env.SPARK_VERSION}-bin-hadoop2.7.tgz
                    """
            }
        }

        stage('Prepare Environment') {
            steps {
                sh """
                        # Transform build number to start with 0
                        BUILD_NUMBER="\$(( $BUILD_NUMBER - 1 ))"
                        
                        # Do everything in the job directory. Ignore the standard jenkins workspace.
                        mkdir -p ${BUILD_NUMBER_DIR}
                    """
            }
        }

        stage('Clone the repository'){
            steps{
                dir("${env.BUILD_NUMBER_DIR}") {
                    checkout scm
                }
            }
        }

        stage('Build Sparkling Water'){
            steps {
                withCredentials([file(credentialsId: 'release-gradle.properties', variable: 'GRADLE_PROPERTIES_PATH'),
                                 file(credentialsId: 'release-secret-key-ring-file', variable: 'RING_FILE_PATH')]) {
                    dir("${env.BUILD_NUMBER_DIR}") {
                        sh """
                            # Update gradle build number
                            sed -i.backup -E "s/\\.[0-9]+-SNAPSHOT/.$BUILD_NUMBER/" gradle.properties
                            REL_VERSION=`cat gradle.properties | grep version | grep -v '#' | sed -e "s/.*=//"`
                            NEXT_BUILD_NUMBER=\$(( $BUILD_NUMBER + 1 ))
                            NEW_VERSION=`echo "\$REL_VERSION" | sed -E "s/\\.[0-9]+\$/.\${NEXT_BUILD_NUMBER}-SNAPSHOT/"`
                            echo "org.gradle.jvmargs=-XX:MaxPermSize=512m -Xmx1024m" >> gradle.properties
                            echo 
                            echo "gradle.properties"
                            cat gradle.properties
                            echo
                            echo "RELEASE VERSION: \${REL_VERSION}"
                            echo "NEW VERSION: \${NEW_VERSION}"
                            echo
                            
                            # Fetch H2O python package
                            mkdir -p private/
                            curl \$(./gradlew -q printH2OWheelPackage) > private/h2o.whl
                            export H2O_PYTHON_WHEEL="\$(pwd)/private/h2o.whl"
                            
                            # Perform a build
                            ./gradlew build -x check 
                            ./gradlew buildSparklingWaterDist
                            
                            # Restore gradle.properties before release
                            git checkout -- gradle.properties
                            cat ${GRADLE_PROPERTIES_PATH} >> gradle.properties
                            echo signing.secretKeyRingFile=$RING_FILE_PATH >> gradle.properties
                            ./gradlew -PdoPromotion -PdoRelease -Pgradle.release.useAutomaticVersion=true -PreleaseVersion="\$REL_VERSION" -PnewVersion="\$NEW_VERSION" release -x check
                            # Restore gradle.properties before pushing to S3
                            git checkout -- gradle.properties
                        """
                    }
                }
            }
        }


        stage('Create Extended H2O Jars'){
            steps {
                dir("${env.BUILD_NUMBER_DIR}"){
                    sh """
                        # Create h2o extended jar for all supported hadoop distributions
                        HADOOP_DISTRIBUTIONS=`./gradlew -q :sparkling-water-assembly-h2o:printHadoopDistributions)`
                        for distro in \${HADOOP_DISTRIBUTIONS}
                        do
                          ./gradlew extendJar -PdownloadH2O="\${distro}"
                        done
                        # Create extended jar also for the regular h2o ( no h2o driver )
                        ./gradlew extendJar -PdownloadH2O
                    """
                }
            }
        }

        stage('Publish to S3') {
            steps {
                dir("${env.BUILD_NUMBER_DIR}"){
                    sh  """
                            s3cmd --rexclude='target/classes/*' --acl-public sync dist/build/ s3://h2o-release/sparkling-water/${BRANCH_NAME}/${BUILD_NUMBER}/
                            
                            echo EXPLICITLY SET MIME TYPES AS NEEDED
                            list_of_html_files=`find dist/build -name '*.html' | sed 's/dist\\/build\\///g'`
                            echo \${list_of_html_files}
                            for f in \${list_of_html_files}
                            do
                                s3cmd --acl-public --mime-type text/html put dist/build/\${f} s3://h2o-release/sparkling-water/${BRANCH_NAME}/${BUILD_NUMBER}/\${f}
                            done
                            
                            list_of_js_files=`find dist/build -name '*.js' | sed 's/dist\\/build\\///g'`
                            echo \${list_of_js_files}
                            for f in \${list_of_js_files}
                            do
                                s3cmd --acl-public --mime-type text/javascript put dist/build/\${f} s3://h2o-release/sparkling-water/${BRANCH_NAME}/${BUILD_NUMBER}/\${f}
                            done
                            
                            list_of_css_files=`find dist/build -name '*.css' | sed 's/dist\\/build\\///g'`
                            echo \${list_of_css_files}
                            for f in \${list_of_css_files}
                            do
                                s3cmd --acl-public --mime-type text/css put dist/build/\${f} s3://h2o-release/sparkling-water/${BRANCH_NAME}/${BUILD_NUMBER}/\${f}
                            done
                            
                            list_of_extended_jars=`find assembly-h2o/private -name '*-extended.jar' | sed 's/assembly-h2o\\\\/private\\\\///g'`
                            echo \${list_of_extended_jars}
                            for jar in \${list_of_extended_jars}
                            do
                                 s3cmd --acl-public put assembly-h2o/private/\${jar} s3://h2o-release/sparkling-water/${BRANCH_NAME}/${BUILD_NUMBER}/\${jar}
                            done
                            ./gradlew :sparkling-water-assembly-h2o:clean
                            ./gradlew :sparkling-water-assembly-h2o:cleanH2OJars
                            
                            echo UPDATE LATEST POINTER
                            tmpdir=./buildsparklingwater.tmp
                            mkdir -p \${tmpdir}
                            echo ${BUILD_NUMBER} > \${tmpdir}/latest
                            echo "<head>" > \${tmpdir}/latest.html
                            echo "<meta http-equiv=\\"refresh\\" content=\\"0; url=${BUILD_NUMBER}/index.html\\" />" >> \${tmpdir}/latest.html
                            echo "</head>" >> \${tmpdir}/latest.html
                            s3cmd --acl-public put \${tmpdir}/latest s3://h2o-release/sparkling-water/${BRANCH_NAME}/latest
                            s3cmd --acl-public put \${tmpdir}/latest.html s3://h2o-release/sparkling-water/${BRANCH_NAME}/latest.html
                            s3cmd --acl-public put \${tmpdir}/latest.html s3://h2o-release/sparkling-water/${BRANCH_NAME}/index.html
                        """
                }
            }
        }

        stage('Publish To PyPi') {
            steps {
                dir("${env.BUILD_NUMBER_DIR}/py/build/pkg") {
                    withCredentials([usernamePassword(credentialsId: "pypi-credentials", usernameVariable: 'PIPY_USERNAME', passwordVariable: 'PIPY_PASSWORD')]) {
                        sh  """
                            python setup.py sdist
                            twine -u $PIPY_USERNAME -p $PIPY_PASSWORD upload dist/*
                            """
                    }
                }
            }
        }

        stage('Update Success Pointer'){
            steps {
                dir("${env.BRANCH_DIR}") {
                    sh  """
                            rm -f lastSuccessfulBuild
                            ln -s ${BUILD_NUMBER} lastSuccessfulBuild
                        """
                }
            }
        }


    }
}